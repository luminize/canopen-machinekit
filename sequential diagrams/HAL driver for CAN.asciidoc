HAL driver for CAN specs
========================

This document describes the flow of the change of state for various entities.
The source of the diagrams are available in `.msg` format which can be parsed
with link:http://www.mcternan.me.uk/mscgen/[with the program MSCgen] to
generate sequential charts.

To keep things simple we try to keep the vertical bars (which are the entities,
or Functions if you will) to a minimum. And try to
follow the PEP mantra: 

[NOTE]
====
"Precondition, Events, Post condition"
====

index

. <<test,bla bla>>


= Discover buses

When Machinekit starts, its unknown if and how many devices are on how many
CAN buses.

- precondition: unknown amount of CAN buses
- endcondition: known amount of CAN buses

image:discover buses.png[]

= Device properties

== Discover devices

=== discover at startup

When a/multiple bus(es) exist then we need to figure out which devices are
on the bus. That needs to be done with a signal (Canopen NMT reset node message,
for normal CAN probably by polling. Unknown at this time). We will focus on
CANopen.

- precondition: known CAN bus
- precondition: unknown device
- endcondition: discovered device

image:discover devices at startup.png[]

=== monitor device startup

When a device gets connected it sends on bootup a NMT message. This message can
be caught and acted upon.

- precondition: known CAN bus
- precondition: unknown device
- endcondition: discovered device

image:discover devices monitor.png[]

== [[test]]Setting up

=== Defining properties

after knowing about the availability of devices, we need to define the device
properties of our hardware device by knowing at least some information for
makingfurther decisions on how to proceed:
- type
- manufacturer
- profile
- ?

- precondition: discovered device
- endcondition: defined device

image:define device.png[]

=== Defining registers

==== TPDO's

==== RPDO's

==== SYNC

==== Heartbeat

= Changing states of devices

== NMT states

== DS402 profiles

=== Pre-operational

=== Homing

=== Position

=== Velocity

= Communication between device and HAL

== from HAL pin to device

== from Device to HAL

== monitoring errors


